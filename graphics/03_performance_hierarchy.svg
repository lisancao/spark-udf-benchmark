<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 860" font-family="'Segoe UI', Arial, Helvetica, sans-serif">
  <defs>
    <linearGradient id="h-builtin" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#238636"/><stop offset="100%" stop-color="#2ea043"/>
    </linearGradient>
    <linearGradient id="h-sql" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#1f6feb"/><stop offset="100%" stop-color="#388bfd"/>
    </linearGradient>
    <linearGradient id="h-arrow" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#E25A1C"/><stop offset="100%" stop-color="#F47A3E"/>
    </linearGradient>
    <linearGradient id="h-pandas" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#d4920b"/><stop offset="100%" stop-color="#e3a917"/>
    </linearGradient>
    <linearGradient id="h-arrowudf" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#8957e5"/><stop offset="100%" stop-color="#a371f7"/>
    </linearGradient>
    <linearGradient id="h-arrowopt" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#9C4221"/><stop offset="100%" stop-color="#C05621"/>
    </linearGradient>
    <linearGradient id="h-pickle" x1="0" x2="1" y1="0" y2="0">
      <stop offset="0%" stop-color="#D13913"/><stop offset="100%" stop-color="#E45A3B"/>
    </linearGradient>
    <filter id="shadow">
      <feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.06"/>
    </filter>
  </defs>

  <rect width="960" height="860" fill="#FFFFFF"/>
  <rect x="0" y="0" width="960" height="4" fill="#E25A1C"/>

  <!-- Title -->
  <text x="480" y="40" font-size="22" fill="#1A202C" text-anchor="middle" font-weight="bold" letter-spacing="1">PySpark UDF Performance Hierarchy</text>
  <text x="480" y="62" font-size="13" fill="#718096" text-anchor="middle">Verified overhead at 50M rows (Spark 4.1.0, Spark Connect) -- lower is faster</text>

  <!-- ════ Tier 1: JVM-native ════ -->
  <rect x="30" y="82" width="900" height="170" rx="10" fill="#F0FFF4" stroke="#C6F6D5" filter="url(#shadow)"/>
  <text x="52" y="104" font-size="11" fill="#276749" font-weight="bold" letter-spacing="1.5">JVM-NATIVE EXECUTION</text>
  <text x="880" y="104" font-size="11" fill="#276749" text-anchor="end">0.1-0.5s at 50M rows</text>

  <g transform="translate(50, 115)">
    <rect x="0" y="0" width="420" height="40" rx="6" fill="url(#h-builtin)"/>
    <text x="16" y="25" font-size="14" fill="#FFFFFF" font-weight="bold">Built-in functions</text>
    <text x="404" y="25" font-size="14" fill="#FFFFFF" text-anchor="end" font-weight="bold">1.0x</text>
    <text x="436" y="18" font-size="11" fill="#276749">Catalyst + Tungsten codegen</text>
    <text x="436" y="34" font-size="10" fill="#68D391">baseline -- 0.11s arithmetic, 0.49s string</text>
  </g>

  <g transform="translate(50, 165)">
    <rect x="0" y="0" width="420" height="40" rx="6" fill="url(#h-sql)"/>
    <text x="16" y="25" font-size="14" fill="#FFFFFF" font-weight="bold">SQL UDF</text>
    <text x="404" y="25" font-size="14" fill="#FFFFFF" text-anchor="end" font-weight="bold">~1.0x</text>
    <text x="436" y="18" font-size="11" fill="#2B6CB0">Inlined by Catalyst optimizer</text>
    <text x="436" y="34" font-size="10" fill="#63B3ED">no overhead -- 0.09s arithmetic, 0.48s string</text>
  </g>

  <text x="52" y="232" font-size="11" fill="#276749" font-style="italic">Use when: Logic expressible in SQL or built-in Spark functions -- essentially free</text>

  <!-- ════ Tier 2: Vectorized Python ════ -->
  <rect x="30" y="268" width="900" height="250" rx="10" fill="#FFFFF0" stroke="#FEFCBF" filter="url(#shadow)"/>
  <text x="52" y="290" font-size="11" fill="#975A16" font-weight="bold" letter-spacing="1.5">VECTORIZED PYTHON (ARROW BATCHES)</text>
  <text x="880" y="290" font-size="11" fill="#975A16" text-anchor="end">0.7-2.9s at 50M rows</text>

  <!-- @pandas_udf bar -->
  <g transform="translate(50, 301)">
    <rect x="0" y="0" width="420" height="40" rx="6" fill="url(#h-pandas)"/>
    <text x="16" y="25" font-size="14" fill="#FFFFFF" font-weight="bold">@pandas_udf</text>
    <text x="404" y="25" font-size="14" fill="#FFFFFF" text-anchor="end" font-weight="bold">~5-10x</text>
    <text x="436" y="18" font-size="11" fill="#975A16">Arrow batch transfer + Pandas/NumPy ops</text>
    <text x="436" y="34" font-size="10" fill="#238636" font-weight="bold">Best option for Python logic</text>
  </g>

  <!-- @arrow_udf bar -->
  <g transform="translate(50, 355)">
    <rect x="0" y="0" width="420" height="40" rx="6" fill="url(#h-arrowudf)"/>
    <text x="16" y="25" font-size="14" fill="#FFFFFF" font-weight="bold">@arrow_udf</text>
    <text x="404" y="25" font-size="14" fill="#FFFFFF" text-anchor="end" font-weight="bold">~3-9x</text>
    <text x="436" y="18" font-size="11" fill="#6B46C1">pyarrow.compute, no Pandas conversion overhead</text>
    <text x="436" y="34" font-size="10" fill="#8957e5">verified at 50M — fastest for string ops (1.55s vs 2.51s)</text>
  </g>

  <!-- @udf(useArrow) bar -->
  <g transform="translate(50, 409)">
    <rect x="0" y="0" width="420" height="40" rx="6" fill="url(#h-arrow)"/>
    <text x="16" y="25" font-size="14" fill="#FFFFFF" font-weight="bold">@udf(useArrow)</text>
    <text x="404" y="25" font-size="14" fill="#FFFFFF" text-anchor="end" font-weight="bold">~9-29x</text>
    <text x="436" y="18" font-size="11" fill="#9C4221">ArrowEvalPython, per-row Python</text>
    <text x="436" y="34" font-size="10" fill="#E25A1C">vectorized transport, scalar execution</text>
  </g>

  <!-- "Start here" callout spanning @pandas_udf and @arrow_udf -->
  <rect x="720" y="324" width="195" height="48" rx="12" fill="#238636"/>
  <text x="818" y="343" font-size="11" fill="#FFFFFF" text-anchor="middle" font-weight="bold">If you need Python,</text>
  <text x="818" y="359" font-size="11" fill="#FFFFFF" text-anchor="middle" font-weight="bold">start here</text>
  <!-- Bracket lines connecting callout to both bars -->
  <line x1="720" y1="336" x2="700" y2="321" stroke="#238636" stroke-width="1.5"/>
  <line x1="720" y1="360" x2="700" y2="375" stroke="#238636" stroke-width="1.5"/>

  <text x="52" y="498" font-size="11" fill="#975A16" font-style="italic">Use when: Need Python + can use Pandas/NumPy vectorized operations</text>

  <!-- ════ Tier 3: Row-at-a-time Python ════ -->
  <rect x="30" y="534" width="900" height="195" rx="10" fill="#FFF5F5" stroke="#FED7D7" filter="url(#shadow)"/>
  <text x="52" y="556" font-size="11" fill="#9B2C2C" font-weight="bold" letter-spacing="1.5">ROW-AT-A-TIME PYTHON (PER-ROW SERDE)</text>
  <text x="880" y="556" font-size="11" fill="#9B2C2C" text-anchor="end">5.2-6.2s at 50M rows</text>

  <g transform="translate(50, 569)">
    <rect x="0" y="0" width="420" height="40" rx="6" fill="url(#h-arrowopt)"/>
    <text x="16" y="25" font-size="14" fill="#FFFFFF" font-weight="bold">@udf + arrow config</text>
    <text x="404" y="25" font-size="14" fill="#FFFFFF" text-anchor="end" font-weight="bold">~13-69x</text>
    <text x="436" y="18" font-size="11" fill="#9C4221">Arrow format, still per-row execution</text>
    <text x="436" y="34" font-size="10" fill="#FC8181">format change only -- 5.24s arithmetic</text>
  </g>

  <g transform="translate(50, 623)">
    <rect x="0" y="0" width="420" height="40" rx="6" fill="url(#h-pickle)"/>
    <text x="16" y="25" font-size="14" fill="#FFFFFF" font-weight="bold">@udf (default)</text>
    <text x="404" y="25" font-size="14" fill="#FFFFFF" text-anchor="end" font-weight="bold">~13-69x</text>
    <text x="436" y="18" font-size="11" fill="#9B2C2C">Pickle ser/de, per-row execution</text>
    <text x="436" y="34" font-size="10" fill="#FC8181">default -- avoid at scale -- 5.20s arithmetic</text>
  </g>

  <text x="52" y="709" font-size="11" fill="#9B2C2C" font-style="italic">Last resort: Per-row Python logic that can't use Pandas/NumPy vectorization</text>

  <!-- Key insight box -->
  <rect x="50" y="735" width="860" height="75" rx="8" fill="#EBF8FF" stroke="#BEE3F8"/>
  <text x="72" y="757" font-size="12" fill="#2B6CB0" font-weight="bold">Practical guidance:</text>
  <text x="185" y="757" font-size="12" fill="#2D3748">Can you use SQL? Free. Need Python? Start with @arrow_udf (3-9x) or @pandas_udf (5-10x). Can't vectorize? Try @udf(useArrow) (9-29x).</text>
  <text x="72" y="777" font-size="12" fill="#2D3748">Arrow transport config has zero effect on @udf (48.9x vs 48.5x at 50M, 69.0x vs 69.2x at 100M).</text>
  <text x="72" y="797" font-size="12" fill="#2D3748">At 50M rows, @arrow_udf finishes in 0.73s arithmetic vs 5.20s for default @udf -- a 7.1x real-time saving.</text>

  <!-- Scale indicator -->
  <g transform="translate(910, 115)">
    <line x1="0" y1="0" x2="0" y2="555" stroke="#CBD5E0" stroke-width="1.5"/>
    <polygon points="-5,0 5,0 0,-8" fill="#238636"/>
    <text x="0" y="-12" font-size="9" fill="#238636" text-anchor="middle">Faster</text>
    <polygon points="-5,555 5,555 0,563" fill="#D13913"/>
    <text x="0" y="577" font-size="9" fill="#D13913" text-anchor="middle">Slower</text>
  </g>

  <!-- Footer -->
  <text x="480" y="840" font-size="10" fill="#A0AEC0" text-anchor="middle" font-style="italic">Measured on Spark 4.1.0, Python 3.12, Spark Connect local[*], 32GB driver memory. Validated from 100K to 100M rows.</text>

  <rect x="0" y="856" width="960" height="4" fill="#E25A1C"/>
</svg>